/* have to change '$' to 'jQuery' to avoid conflict with Prototype in image show view */

jQuery(function () {

    BlacklightGoogleAnalytics = {}

    // Necessary to leave some time for the async GA code to run before the browser
    // stops javascript execution and sends the user to the new page.
    BlacklightGoogleAnalytics.pause = function(){
        // pause to allow google script to run before going to new page
        var date = new Date();
        var curDate = null;
        do {
            curDate = new Date();
        } while(curDate-date < 300);
    };

    BlacklightGoogleAnalytics.console_log_error = function(err, values){
        <% if Rails.env == 'development' %>
        // good place to log in development
        console.log(err);
        console.log(values);
        <% end %>
    };

    BlacklightGoogleAnalytics.this_or_parent_id = function(that){
        if (that.get(0).id.length > 0){
            var identifier = that.get(0).id;
        } else {
            var identifier = that.parents('[id]:first').get(0).id;
        }
        return identifier;
    };

    BlacklightGoogleAnalytics.rails_category = function () {
        return jQuery('body').attr('class').split(' ').slice(-1).toString().replace(/blacklight-/,'').replace(/-/,'#');
    };

    jQuery('a').click(function () {
    // tell analytics to save event
        try {
            var category = BlacklightGoogleAnalytics.rails_category();
            var action = BlacklightGoogleAnalytics.this_or_parent_id(jQuery(this));
            var label = (jQuery(this).text() || jQuery(this).children('img:first').attr('alt'));
            // for facets we make the action the facet heading
            if (action === 'facets-collapse') {
                var action = 'facet_' + jQuery(this).parents("div:first").find("h5:first").text().trim();
            } else if (action === 'documents') {
                var action = 'result_' + jQuery(this).parents("div:first").attr('class');
                if (jQuery(this).data('counter')) {
                    var label = jQuery(this).data('counter');
                }
            } else if (action === 'item_metadata') {
                var label = jQuery(this).parent().prev("dt").text().replace(/:/,'');
            } else if (action === 'item_breadcrumb') {
                var label = jQuery(this).attr('class');

            }

            ga('send', 'event', category, action, label);
        } catch (err) {
            BlacklightGoogleAnalytics.console_log_error(err, [category, action, label]);
        }
        //BlacklightGoogleAnalytics.pause();
    });

    // OAI item clicks
    jQuery("#oai_img_show_container").find("a").click(function(){
        try{
            var category = BlacklightGoogleAnalytics.rails_category();
            var action = 'oai_item_link';
            var label = jQuery('#item_breadcrumb').find("a.institution_breadcrumb").text();
            ga('send', 'event', category, action, label);
        } catch(err) {
            BlacklightGoogleAnalytics.console_log_error(err, [category, action, label]);
        }
    });

    // saved searches clicks
    jQuery("#searches_content").find("a").click(function(){
        try{
            var category = BlacklightGoogleAnalytics.rails_category();
            if (jQuery(this).attr('class')) {
                var action = jQuery(this).attr('class');
            } else {
                var action = 'link_to_previous_search';
            }
            ga('send', 'event', category, action);
        } catch(err) {
            BlacklightGoogleAnalytics.console_log_error(err, [category, action]);
        }
    });















   /*
// all links get tracked
   jQuery('a').click(function () {
// tell analytics to save event
        try {
            var identifier = BlacklightGoogleAnalytics.this_or_parent_id(jQuery(this));
            // for facets we make the action the facet heading
            if (identifier === 'facets') {
                var action = jQuery(this).parents("div:first").find("h3:first").text();
            } else {
                var action = 'clicked';
            }
            var label = (jQuery(this).text() || jQuery(this).children('img:first').attr('alt'));
            _gaq.push(['_trackEvent', identifier, action, label]);
        } catch (err) {
            BlacklightGoogleAnalytics.console_log_error(err, [identifier, action, label]);
        }
        BlacklightGoogleAnalytics.pause();
   });

    jQuery('input,select').click(function(){
        try {
            var identifier = BlacklightGoogleAnalytics.this_or_parent_id(jQuery(this));
            var action = 'clicked';
            var label = jQuery(this).val();
            _gaq.push(['_trackEvent', identifier, action, label]);
        } catch (err){
            BlacklightGoogleAnalytics.console_log_error(err, [identifier, action, label]);
        }
        BlacklightGoogleAnalytics.pause();
    });
    */
    // the two event-tracking functions below don't have any relevance in this app
    /*
    //facet expand/collapse
    jQuery('#facets h3').live('click', function(){
        var label = jQuery(this).text();
        var heading_values = ['facets', 'collapse_expand', label];
        try{
            _gaq.push(['_trackEvent'].concat(heading_values));
        } catch(err) {
            BlacklightGoogleAnalytics.console_log_error(err, heading_values);
        }
    });

    //which number in the search results was clicked on?
    jQuery('h3.index_title a').click(function(){
        var result_number = jQuery(this).data('counter');
        var heading_values = ['result_number', 'click', result_number];
        try{
            _gaq.push(['_trackEvent'].concat(heading_values));
        } catch(err) {
            BlacklightGoogleAnalytics.console_log_error(err, heading_values);
        }
    });
    */

});
