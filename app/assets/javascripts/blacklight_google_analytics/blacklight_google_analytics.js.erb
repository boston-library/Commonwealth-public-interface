/* have to change '$' to 'jQuery' to avoid conflict with Prototype in image show view */

(function(jQuery) {

    BlacklightGoogleAnalytics = {}

    // Necessary to leave some time for the async GA code to run before the browser
    // stops javascript execution and sends the user to the new page.
    BlacklightGoogleAnalytics.pause = function(){
        // pause to allow google script to run before going to new page
        var date = new Date();
        var curDate = null;
        do {
            curDate = new Date();
        } while(curDate-date < 300);
    };

    BlacklightGoogleAnalytics.console_log_error = function(err, values){
        <% if Rails.env == 'development' %>
        // good place to log in development
        console.log(err);
        console.log(values);
        <% end %>
    };

    BlacklightGoogleAnalytics.this_or_parent_id = function(that){
        if (that.get(0).id.length > 0){
            var identifier = that.get(0).id;
        } else {
            var identifier = that.parents('[id]:first').get(0).id;
        }
        return identifier;
    };

    BlacklightGoogleAnalytics.rails_category = function () {
        return jQuery('body').attr('class').split(' ')[1].toString().replace(/blacklight-/,'').replace(/-/,'#');
    };

    BlacklightGoogleAnalytics.track_link_clicks = function () {
        jQuery('a').click(function () {
            // tell analytics to save event
            try {
                var category = BlacklightGoogleAnalytics.rails_category();
                var action = BlacklightGoogleAnalytics.this_or_parent_id(jQuery(this));
                var label = (jQuery(this).text() || jQuery(this).children('img:first').attr('alt'));
                if (action === 'facets-collapse') { // for facets, make the action the facet heading
                    var action = 'facet_' + jQuery(this).parents("div:first").find("h5:first").text().trim();
                } else if (action === 'documents') { // search results
                    var action = 'result_' + jQuery(this).parents("div:first").attr('class');
                    if (jQuery(this).data('counter')) {
                        var label = jQuery(this).data('counter');
                    }
                } else if (action === 'item_metadata') { // catalog#show metadata links
                    var label = jQuery(this).parent().prev("dt").text().replace(/:/,'');
                } else if (action === 'item_breadcrumb') { // catalog#show breadcrumb
                    var label = jQuery(this).attr('class');
                } else if (action === 'institution_site_link') { // institutions#show external site URL
                    var label = jQuery('img.institution_img_show').attr('alt');
                }

                ga('send', 'event', category, action, label);
            } catch (err) {
                BlacklightGoogleAnalytics.console_log_error(err, [category, action, label]);
            }
            //BlacklightGoogleAnalytics.pause();
        });
    };

    // "more" facet ajax-modal clicks
    BlacklightGoogleAnalytics.track_modal_facet_clicks = function () {
        jQuery('a').click(function () {
            try {
                var category = BlacklightGoogleAnalytics.rails_category();
                var action = 'facet_' + jQuery('div.modal-header').find('h3').text();
                var label = jQuery(this).text();
                ga('send', 'event', category, action, label);
            } catch (err) {
                BlacklightGoogleAnalytics.console_log_error(err, [category, action, label]);
            }
        });
    };

    // OAI item clicks
    jQuery("#oai_img_show_container").find("a").click(function(){
        try{
            var category = BlacklightGoogleAnalytics.rails_category();
            var action = 'oai_item_link';
            var label = jQuery('#item_breadcrumb').find("a.institution_breadcrumb").text();
            ga('send', 'event', category, action, label);
        } catch(err) {
            BlacklightGoogleAnalytics.console_log_error(err, [category, action, label]);
        }
    });

    // saved searches clicks
    jQuery("#searches_content").find("a").click(function(){
        try{
            var category = BlacklightGoogleAnalytics.rails_category();
            if (jQuery(this).attr('class')) {
                var action = jQuery(this).attr('class');
            } else {
                var action = 'link_to_saved_search';
            }
            ga('send', 'event', category, action);
        } catch(err) {
            BlacklightGoogleAnalytics.console_log_error(err, [category, action]);
        }
    });

    // search history clicks
    jQuery("#searches_list").find("a").click(function(){
        try{
            var category = BlacklightGoogleAnalytics.rails_category();
            var action = 'link_to_previous_search';
            ga('send', 'event', category, action);
        } catch(err) {
            BlacklightGoogleAnalytics.console_log_error(err, [category, action]);
        }
    });

    // collections#show series clicks
    jQuery("#series_wrapper").find("a").click(function(){
        try{
            var category = BlacklightGoogleAnalytics.rails_category();
            var action = 'series_' + jQuery(this).parents("div:first").attr('class');
            var label = (jQuery(this).text() || jQuery(this).children('img:first').attr('alt'));
            ga('send', 'event', category, action, label);
        } catch(err) {
            BlacklightGoogleAnalytics.console_log_error(err, [category, action, label]);
        }
    });

    // institutions#show collection clicks
    jQuery("#institution_collections").find("a").click(function(){
        try{
            var category = BlacklightGoogleAnalytics.rails_category();
            var action = 'collections_' + jQuery(this).parents("div:first").attr('class');
            var label = (jQuery(this).text() || jQuery(this).children('img:first').attr('alt'));
            ga('send', 'event', category, action, label);
        } catch(err) {
            BlacklightGoogleAnalytics.console_log_error(err, [category, action, label]);
        }
    });

    // form submissions
    jQuery("form.header-search-form").submit(function(){
        try{
            var category = BlacklightGoogleAnalytics.rails_category();
            var action = BlacklightGoogleAnalytics.this_or_parent_id(jQuery(this));
            ga('send', 'event', category, action);
        } catch(err) {
            BlacklightGoogleAnalytics.console_log_error(err, [category, action]);
        }
    });

    jQuery(document).ready( function() {
        BlacklightGoogleAnalytics.track_link_clicks();
    });


   /*


    jQuery('input,select').click(function(){
        try {
            var identifier = BlacklightGoogleAnalytics.this_or_parent_id(jQuery(this));
            var action = 'clicked';
            var label = jQuery(this).val();
            _gaq.push(['_trackEvent', identifier, action, label]);
        } catch (err){
            BlacklightGoogleAnalytics.console_log_error(err, [identifier, action, label]);
        }
        BlacklightGoogleAnalytics.pause();
    });
    */

})(jQuery);
